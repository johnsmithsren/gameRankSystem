# 游戏排行榜系统

## 功能特性

### 核心功能

- **实时排行榜**
  - 玩家分数更新与实时排名计算
  - 分页查询功能
  - 个人排名查询
  - 相邻排名查询（前后 N 名）

### 实时通知系统

- **WebSocket 实时推送**
  - 智能连接管理
  - 排名变化即时通知
  - 上榜提醒与超越通知
  - 自动断线重连机制

## 技术架构

### 服务架构

系统采用微服务架构设计，主要分为两个核心服务：

- **HTTP API 服务**

  - 处理所有 REST API 请求
  - 负责排行榜数据查询，通过 Redis 实现
  - 处理玩家分数更新，将请求转发至消息队列
  - 消息队列处理核心业务逻辑：数据更新、首次上榜判定、玩家超越统计等，并将广播消息编码后通过 BullMQ 发送至 WebSocket 服务进行推送

- **WebSocket 实时服务**
  - 维护玩家实时连接
  - 处理消息队列推送的实时消息

### 核心组件

- **数据存储**
  - Redis 实现高性能排行榜
  - Redis 缓存优化玩家信息访问

### 消息处理

- **异步消息队列**
  - BullMQ 消息队列
  - 异步更新机制
  - WebSocket 实时数据推送

### 权衡设计

1. 引入消息队列作为削峰方案，有效降低并发压力，保障数据一致性

### 功能增强

- 完善的用户鉴权系统
- 引入 Kafka 消息队列
  - 提供更强大的消息持久化能力
  - 提升系统可靠性
- 消息失败重试机制
- 请求频率限制
- 缓存预热机制
- 错误监控告警（支持企业微信等消息平台）
- 引入 API Gateway 实现 WebSocket 服务负载均衡
- PM2 集群部署支持
- Redis 集群部署支持
- 消息队列幂等性保障（通过 requestId 防止重复消费）
- 性能优化：考虑将 Mongoose 数据更新操作迁移至独立微服务，实现异步更新，提升主服务性能

### 部署与测试

- **测试环境**

  - WebSocket 项目：`public` 目录下提供测试客户端页面
  - RankSystem 项目：`test/rankTest.js` 提供接口测试脚本

- **部署说明**
  两个项目均基于 NestJS 框架开发，部署步骤：

  1. 分别构建打包
  2. 部署至服务器
  3. 配置环境变量（.env 文件）

- **环境变量配置**

```env
MONGOURL='mongodb://username:password@host/gameRank?authSource=admin'
REDIS_HOST='host'
REDIS_PORT='6380'
REDIS_PASSWORD="password"
REDIS_DB="dbnum"
PORT=4000
```

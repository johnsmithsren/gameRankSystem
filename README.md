# 游戏排行榜系统

## 功能特性

### 核心功能

- **实时排行榜**
  - 玩家分数更新与实时排名计算
  - 分页查询功能
  - 个人排名查询
  - 相邻排名查询（前后 N 名）

### 实时通知系统

- **WebSocket 实时推送**
  - 智能连接管理
  - 排名变化即时通知
  - 上榜提醒与超越通知
  - 自动断线重连机制

## 技术架构

### 服务架构

系统采用微服务架构设计，主要分为两个核心服务：

- **HTTP API 服务**

  - 处理所有 REST API 请求
  - 负责排行榜数据查询，通过 redis 实现
  - 处理玩家分数更新，接收到请求后，发给 bullMq，通过 bullMq 来实现处理消息
  - 通过 bullMq 发送消息到 WebSocket 服务，webSocket 服务负责实时推送

- **WebSocket 实时服务**
  - 维护实时连接池
  - 处理实时数据推送
  - 发送排名变化通知
  - 实现断线重连机制

### 核心组件

- **数据存储**
  - Redis 实现高性能排行榜
  - Redis 缓存优化玩家信息访问

### 消息处理

- **异步消息队列**
  - BullMQ 消息队列
  - 异步更新机制
  - WebSocket 实时数据推送

### 权衡

1. 通过消息队列削峰，避免并发处理导致数据库压力过大

### 功能增强

- 完善的用户鉴权系统
- 引入 Kafka 消息队列
  - 提供更强大的消息持久化能力
  - 提升系统可靠性
- 消息失败重试机制
- 请求频率的限制
- 添加缓存预热机制
- 添加报错监控，发送消息处理失败信息企业微信等消息平台
- 通过构建 Gateway 服务，来对 websocket 服务进行负载均衡
- PM2 集群部署支持
- redis 集群部署支持

### 部署方式

这两个都是 nestjs 应用
分别打包，部署都服务器上，然后在服务器上手动创建.env 文件

.env 文件格式

```
MONGOURL='mongodb://xxxx@xxx/gameRank?authSource=admin'
REDIS_HOST='xxxx'
REDIS_PORT='6380'
REDIS_PASSWORD="xxx"
REDIS_DB="xxx"
PORT=4000
```
